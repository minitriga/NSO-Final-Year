<config-template 
    xmlns="http://tail-f.com/ns/config/1.0" servicepoint="DEPLOY-DMVPN">
    <devices 
        xmlns="http://tail-f.com/ns/ncs">
        <device foreach="{/HUB}" when="{/HUB}">
            <name>{device}</name>
            <config>
                <crypto 
                    xmlns="urn:ios">
                    <isakmp>
                        <policy>
                            <priority>10</priority>
                            <encr>
                                <algorithm>3des</algorithm>
                            </encr>
                            <hash>sha256</hash>
                            <authentication>pre-share</authentication>
                        </policy>
                        <key>
                            <address>0.0.0.0</address>
                            <keystring>{/ipsec-secret}</keystring>
                        </key>
                    </isakmp>
                    <ipsec>
                        <transform-set>
                            <name>MINE</name>
                            <transform2>esp-3des</transform2>
                            <mode>
                                <tunnel/>
                            </mode>
                        </transform-set>
                        <profile>
                            <name>DMVPN</name>
                            <set>
                                <transform-set>MINE</transform-set>
                            </set>
                        </profile>
                    </ipsec>
                </crypto>
                <interface 
                    xmlns="urn:ios">
                    <Tunnel>
                        <name>0</name>
                        <ip>
                            <address>
                                <primary>
                                    <address>{hub-tunnel-address}</address>
                                    <mask>{hub-tunnel-mask}</mask>
                                </primary>
                            </address>
                            <hold-time>
                                <eigrp>
                                    <as-number>1</as-number>
                                    <seconds>35</seconds>
                                </eigrp>
                            </hold-time>
                            <nhrp>
                                <map>
                                    <multicast>
                                        <dynamic/>
                                    </multicast>
                                </map>
                                <network-id>1</network-id>
                            </nhrp>
                            <mtu>1416</mtu>
                        </ip>
                        <tunnel>
                            <source>{interface-type}{interface-number}.{sub-interface-number}</source>
                            <mode>
                                <gre>
                                    <multipoint/>
                                </gre>
                            </mode>
                            <protection>
                                <ipsec>
                                    <profile>DMVPN</profile>
                                </ipsec>
                            </protection>
                        </tunnel>
                    </Tunnel>
                </interface>
                <router 
                    xmlns="urn:ios">
                    <eigrp-virtual-instance>
                        <eigrp>
                            <name>DMVPN</name>
                            <address-family>
                                <ipv4>
                                    <af>unicast</af>
                                    <autonomous-system>1</autonomous-system>
                                    <topology>
                                        <base/>
                                    </topology>
                                    <af-interface>
                                        <name>Tunnel0</name>
                                        <next-hop-self>false</next-hop-self>
                                        <split-horizon>false</split-horizon>
                                    </af-interface>
                                    <network foreach="{eigrp}" when="{eigrp}">
                                        <ip>{network}</ip>
                                        <mask>{network-mask}</mask>
                                    </network>
                                </ipv4>
                            </address-family>
                        </eigrp>
                    </eigrp-virtual-instance>
                </router>
            </config>
        </device>
    </devices>
    <devices 
        xmlns="http://tail-f.com/ns/ncs">
        <device foreach="{/SPOKE}" when="{/SPOKE}">
            <name>{device}</name>
            <config>
                <crypto 
                    xmlns="urn:ios">
                    <isakmp>
                        <policy>
                            <priority>10</priority>
                            <encr>
                                <algorithm>3des</algorithm>
                            </encr>
                            <hash>sha256</hash>
                            <authentication>pre-share</authentication>
                        </policy>
                        <key>
                            <address>0.0.0.0</address>
                            <keystring>{/ipsec-secret}</keystring>
                        </key>
                    </isakmp>
                    <ipsec>
                        <transform-set>
                            <name>MINE</name>
                            <transform2>esp-3des</transform2>
                            <mode>
                                <tunnel/>
                            </mode>
                        </transform-set>
                        <profile>
                            <name>DMVPN</name>
                            <set>
                                <transform-set>MINE</transform-set>
                            </set>
                        </profile>
                    </ipsec>
                </crypto>
                <interface 
                    xmlns="urn:ios">
                    <Tunnel>
                        <name>0</name>
                        <ip>
                            <address>
                                <primary>
                                    <address>{spoke-tunnel-address}</address>
                                    <mask>{spoke-tunnel-mask}</mask>
                                </primary>
                            </address>
                            <redirects>false</redirects>
                            <hold-time>
                                <eigrp>
                                    <as-number>1</as-number>
                                    <seconds>35</seconds>
                                </eigrp>
                            </hold-time>
                            <nhrp>
                                <map>
                                    <map-list>
                                        <ip-address>{hub-tunnel-address}</ip-address>
                                        <nbma-address>{hub-public-address}</nbma-address>
                                    </map-list>
                                    <multicast>
                                        <multicast-list>
                                            <nbma-address>{hub-public-address}</nbma-address>
                                        </multicast-list>
                                    </multicast>
                                </map>
                                <network-id>1</network-id>
                                <nhs>
                                    <nhs-list>
                                        <nhs-address>{hub-tunnel-address}</nhs-address>
                                    </nhs-list>
                                </nhs>
                            </nhrp>
                            <mtu>1416</mtu>
                        </ip>
                        <tunnel>
                            <source>{interface-type}{interface-number}.{sub-interface-number}</source>
                            <mode>
                                <gre>
                                    <multipoint/>
                                </gre>
                            </mode>
                            <protection>
                                <ipsec>
                                    <profile>DMVPN</profile>
                                </ipsec>
                            </protection>
                        </tunnel>
                    </Tunnel>
                </interface>
                <router 
                    xmlns="urn:ios">
                    <eigrp-virtual-instance>
                        <eigrp>
                            <name>DMVPN</name>
                            <address-family>
                                <ipv4>
                                    <af>unicast</af>
                                    <autonomous-system>1</autonomous-system>
                                    <af-interface>
                                        <name>Tunnel0</name>
                                        <next-hop-self>false</next-hop-self>
                                        <split-horizon>false</split-horizon>
                                    </af-interface>
                                    <network foreach="{eigrp}" when="{eigrp}">
                                        <ip>{network}</ip>
                                        <mask>{network-mask}</mask>
                                    </network>
                                </ipv4>
                            </address-family>
                        </eigrp>
                    </eigrp-virtual-instance>
                </router>
            </config>
        </device>
    </devices>
</config-template>
